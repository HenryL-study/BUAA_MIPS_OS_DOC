#### Lab4 实验报告

##### Thinking 4.1

- 说明子进程的代码完全是从父进程那里复制过来的。
- 说明子进程执行时，pc是从系统中断时的epc那里开始的。

##### Thinking 4.2

​	选C，父进程调用fork，进入sys_env_alloc，父进程从此处返回后，再返回fork函数，子进程并没有调用fork，当父进程从sys_env_alloc函数返回的时候，父进程的v0寄存器是子进程的id，不为0，而子进程的v0寄存器是在拷贝的时候设置成了0，所以返回值不同。

##### Thinking 4.3

​	我认为除去共享的页，凡是索引有效的应该都要保护。共享的页面感觉是UTOP到UVPT这一段。

##### Thinking 4.4

- vpd和vpt分别是页目录和页表，通过`（*vpd）[va>>22]`和`(*vpt)[VPN(va)]`来访问对应的页目录页和页表页。
- 他们是为了能够在用户空间访问页表和页目录。在实验2中，不是可以直接访问吗？通过`PDX(VA)`和pgdir即可寻得页目录，

#### 实验难点

​	我觉得最难的是fork.c和duppage的填写，大部分思路都是借鉴的JOS源码和一些网上的博客。

​	还就就是一堆sys开头的函数，一开始完全不知道要填，知道了之后有一种崩溃的感觉，太多了。

​	最后就是COW的理解，这个还可以。

#### 心得体会

​	自己给自己挖的坑最难填啊有没有！！！Lab3的env_run忘了用`GET_ENV_ASID`然后导致Lab4莫名其妙的pagefault函数出错，整整3天都耗在这上面了。

​	最大的体会就是反复检查！